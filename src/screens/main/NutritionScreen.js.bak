import React, { useContext, useEffect, useMemo, useState } from 'react';
import { View, Text, StyleSheet, FlatList, Alert } from 'react-native';
import SimpleButton from '../../../components/SimpleButton';
import { AuthContext, db } from '../../config/Firebase';
import { collection, addDoc, onSnapshot } from 'firebase/firestore';

export default function NutritionScreen({ navigation, route }) {
  const { user } = useContext(AuthContext);
  const [foods, setFoods] = useState([]);

  const dateKey = useMemo(() => {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  }, []);

  useEffect(() => { // useEffect para carregar alimentos do dia atual
    if (!user) return;
    const colRef = collection(db, 'users', user.uid, 'days', dateKey, 'consumedFoods');
    const unsubscribe = onSnapshot(colRef, (snap) => {
      const items = [];
      snap.forEach((doc) => items.push({ id: doc.id, ...doc.data() }));
      // Sort newest first by createdAt if present
      items.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
      setFoods(items);
      console.log(`üìã ${items.length} alimentos carregados do Firebase`);
    });
    return unsubscribe;
  }, [user, dateKey]);

  useEffect(() => { // useEffect para detectar novos alimentos adicionados
    const newFood = route?.params?.newFood;
    if (!user || !newFood) return;
    console.log('üìù Novo alimento recebido:', newFood);
    const save = async () => {
      try {
        const colRef = collection(db, 'users', user.uid, 'days', dateKey, 'consumedFoods');
        const foodData = {
          name: newFood.name,
          calories: Number(newFood.calories) || 0,
          protein: Number(newFood.protein) || 0,
          carbs: Number(newFood.carbs) || 0,
          fat: Number(newFood.fat) || 0,
          barcode: newFood.barcode || null,
          date: dateKey,
          createdAt: new Date()
        };
        console.log('Salvando no Firebase:', foodData);
        const docRef = await addDoc(colRef, foodData);
        console.log('Alimento salvo com ID:', docRef.id);
      } catch (error) {
        console.error('Erro ao salvar alimento:', error);
        Alert.alert('Erro', 'N√£o foi poss√≠vel salvar o alimento: ' + error.message);
      } finally {
        navigation.setParams({ newFood: undefined });
      }
    };
    save();
  }, [route?.params?.newFood, user, dateKey, navigation]);

  const totals = useMemo(() => { // useMemo para calcular totais nutricionais
    return foods.reduce(
      (acc, f) => {
        acc.calories += Number(f.calories) || 0;
        acc.protein += Number(f.protein) || 0;
        acc.carbs += Number(f.carbs) || 0;
        acc.fat += Number(f.fat) || 0;
        return acc;
      },
      { calories: 0, protein: 0, carbs: 0, fat: 0 }
    );
  }, [foods]);

  return ( // return renderazi√ß√£o da tela
    <View style={styles.container}>
      <Text style={styles.title}>Nutri√ß√£o</Text>
      
      <SimpleButton title="Registar Alimento" onPress={() => navigation.navigate('AddFood')} />
      <SimpleButton title="Ler C√≥digo de Barras" onPress={() => navigation.navigate('BarcodeScanner')} type="secondary" />

      <View style={styles.summary}>
        <Text style={styles.subtitle}>Resumo Di√°rio</Text>
        <Text>Total Calorias: {totals.calories.toFixed(0)} kcal</Text>
        <Text>Prote√≠nas: {totals.protein.toFixed(1)} g</Text>
        <Text>Carboidratos: {totals.carbs.toFixed(1)} g</Text>
        <Text>Gorduras: {totals.fat.toFixed(1)} g</Text>
      </View>

      <Text style={styles.subtitle}>Alimentos Consumidos Durante o Dia</Text>
      
      <FlatList
        data={foods}
        keyExtractor={item => String(item.id)}
        renderItem={({ item }) => (
          <View style={styles.foodCard}>
            <Text style={styles.foodName}>{item.name}</Text>
            <Text>Calorias: {item.calories} kcal</Text>
            <Text>Prote√≠nas: {item.protein}g</Text>
            <Text>Carboidratos: {item.carbs}g</Text>
            <Text>Gorduras: {item.fat}g</Text>
          </View>
        )}
      />
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    padding: 20,
    backgroundColor: '#f5f5f5'
  },
  title: {
    fontSize: 24,
    fontWeight: 'bold',
    marginBottom: 20
  },
  subtitle: {
    fontSize: 18,
    fontWeight: 'bold',
    marginTop: 20,
    marginBottom: 10
  },
  summary: {
    backgroundColor: 'white',
    padding: 15,
    borderRadius: 10,
    marginBottom: 10,
    borderWidth: 1,
    borderColor: '#eee'
  },
  foodCard: {
    backgroundColor: 'white',
    padding: 15,
    borderRadius: 10,
    marginBottom: 10,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    elevation: 3
  },
  foodName: {
    fontSize: 18,
    fontWeight: 'bold'
  }
});